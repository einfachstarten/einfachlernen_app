<!doctype html>
<html lang="de">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex, nofollow">
<title>Meine Termine – Anna Braun Lerncoaching</title>
<script>
if (window.location.search.includes('email=')) {
    alert('Diese Seite ist nicht mehr verfügbar. Bitte loggen Sie sich ein.');
    window.location.href = '/einfachlernen/login.php';
}
</script>
<style>
  :root {
    --primary: #4a90b8;
    --secondary: #52b3a4;
    --accent-green: #7cb342;
    --accent-teal: #26a69a;
    --accent-blue: #42a5f5;
    --light-blue: #e3f2fd;
    --white: #ffffff;
    --gray-light: #f8f9fa;
    --gray-medium: #6c757d;
    --gray-dark: #343a40;
    --shadow: rgba(0, 0, 0, 0.1);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    background: linear-gradient(135deg, var(--light-blue) 0%, var(--white) 100%);
    min-height: 100vh;
    color: var(--gray-dark);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.4;
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--light-blue) 0%, var(--white) 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.fade-out {
    opacity: 0;
    pointer-events: none;
  }

  .loading-logo {
    width: 100px;
    height: 100px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 30px var(--shadow);
    animation: pulse 2s ease-in-out infinite;
  }

  .loading-text {
    color: var(--primary);
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 1rem;
    text-align: center;
  }

  .loading-subtext {
    color: var(--gray-medium);
    font-size: 1rem;
    text-align: center;
  }

  .loading-dots {
    display: flex;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .loading-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: linear-gradient(45deg, var(--primary), var(--secondary));
    animation: bounce 1.4s ease-in-out infinite both;
  }

  .loading-dot:nth-child(1) { animation-delay: -0.32s; }
  .loading-dot:nth-child(2) { animation-delay: -0.16s; }
  .loading-dot:nth-child(3) { animation-delay: 0s; }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 8px 30px var(--shadow);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    }
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: scale(0);
    }
    40% {
      transform: scale(1);
    }
  }

  .main-content {
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .main-content.show {
    opacity: 1;
  }

  .header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 1rem 0;
    text-align: center;
    box-shadow: 0 2px 15px var(--shadow);
  }

  .logo {
    width: 45px;
    height: 45px;
    margin: 0 auto 0.5rem;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }

  .header h1 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 300;
  }

  .header .subtitle {
    margin: 0.2rem 0 0;
    opacity: 0.9;
    font-size: 0.85rem;
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }

  .user-info {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 3px 15px var(--shadow);
    text-align: center;
  }

  .user-info p {
    margin: 0 0 0.5rem;
    font-size: 1rem;
    color: var(--gray-dark);
  }

  .user-info .email {
    color: var(--primary);
    font-weight: 600;
    font-size: 1rem;
  }

  .calendar-section {
    margin-bottom: 1.5rem;
  }

  .date-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 12px;
    margin: 1.5rem 0 1rem;
    font-size: 1rem;
    font-weight: 600;
    box-shadow: 0 3px 15px var(--shadow);
  }

  .appointment-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 3px 15px var(--shadow);
    border-left: 4px solid var(--primary);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .appointment-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  .appointment-main {
    display: grid;
    grid-template-columns: 200px 1fr 60px;
    gap: 1.5rem;
    align-items: center;
    margin-bottom: 1rem;
  }

  .appointment-date-time {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .date-info {
    color: var(--gray-dark);
    font-size: 1rem;
    font-weight: 600;
  }

  .time-badge {
    background: linear-gradient(45deg, var(--accent-green), var(--accent-teal));
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
  }

  .appointment-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--gray-dark);
  }

  .duration {
    background: var(--light-blue);
    color: var(--primary);
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
  }

  .appointment-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    color: var(--gray-medium);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 0;
  }

  .detail-icon {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    background: var(--light-blue);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
  }

  .detail-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .status-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .status-badge {
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .status-active {
    background: #e8f5e8;
    color: #2e7d32;
  }

  .status-confirmed {
    background: var(--light-blue);
    color: var(--primary);
  }

  .status-created {
    background: var(--gray-light);
    color: var(--gray-medium);
  }

  .appointment-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .action-button {
    background: linear-gradient(45deg, var(--accent-green), var(--accent-teal));
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  .action-button:hover {
    transform: scale(1.05);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  .btn-calendar {
    background: linear-gradient(45deg, var(--primary), var(--secondary));
  }

  .btn-reschedule {
    background: linear-gradient(45deg, var(--gray-medium), #8a8a8a);
  }

  .btn-disabled {
    background: var(--gray-light);
    color: var(--gray-medium);
    cursor: not-allowed;
  }

  .btn-disabled:hover {
    transform: none;
    box-shadow: none;
  }

  .reschedule-notice {
    font-size: 0.8rem;
    color: var(--gray-medium);
    font-style: italic;
    margin-top: 0.5rem;
  }

  .no-appointments {
    text-align: center;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 15px var(--shadow);
  }

  .no-appointments-icon {
    font-size: 3rem;
    color: var(--gray-medium);
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .no-appointments h2 {
    font-size: 1.3rem;
    margin: 0 0 0.5rem;
    color: var(--gray-dark);
  }

  .no-appointments p {
    font-size: 0.9rem;
    margin: 0;
    color: var(--gray-medium);
  }

  .error-message {
    background: #ffebee;
    color: #c62828;
    padding: 1.5rem;
    border-radius: 12px;
    margin: 1rem 0;
    border-left: 4px solid #e53935;
    font-size: 0.95rem;
    box-shadow: 0 3px 15px var(--shadow);
  }

  .error-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }

  .error-details {
    background: #fce4ec;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    font-size: 0.85rem;
    border: 1px solid #f8bbd9;
  }

  .error-actions {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .error-button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-light);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
    margin-right: 0.5rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }
    
    .appointment-main {
      grid-template-columns: 1fr;
      gap: 0.8rem;
      text-align: left;
    }

    .appointment-date-time {
      flex-direction: row;
      gap: 1rem;
      align-items: center;
    }
    
    .time-badge {
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
    }

    .date-info {
      font-size: 0.9rem;
    }

    .appointment-details {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .appointment-details {
      font-size: 0.85rem;
    }

    .date-header {
      font-size: 0.95rem;
      padding: 0.6rem 1rem;
    }

    .action-button {
      padding: 0.6rem 1rem;
      font-size: 0.8rem;
    }

    .loading-logo {
      width: 70px;
      height: 70px;
      font-size: 2.2rem;
    }

    .loading-text {
      font-size: 1rem;
    }

    .loading-subtext {
      font-size: 0.85rem;
    }
  }

  @media (max-width: 480px) {
    .header h1 {
      font-size: 1.2rem;
    }
    
    .logo {
      width: 35px;
      height: 35px;
      font-size: 1.2rem;
    }
    
    .appointment-card {
      padding: 1rem;
    }

    .appointment-date-time {
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start;
    }
    
    .time-badge {
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
    }

    .date-info {
      font-size: 0.8rem;
    }

    .appointment-main {
      grid-template-columns: 1fr;
      gap: 0.6rem;
    }
  }
</style>

<body>
  <!-- Loading Animation -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-logo" id="loadingLogo">🧠</div>
    <div class="loading-text">Termine werden geladen...</div>
    <div class="loading-subtext">Bitte haben Sie einen Moment Geduld</div>
    <div class="loading-dots">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="header">
      <div class="logo">🗓️</div>
      <h1>Anna Braun</h1>
      <p class="subtitle">Meine Termine</p>
    </div>

    <div class="container">
      <div class="user-info">
        <p>Ihre gebuchten Termine</p>
        <div class="email" id="userEmail"></div>
      </div>

      <div id="appointmentsContainer">
        <!-- Termine werden hier eingefügt -->
      </div>
    </div>
  </div>

  <script>
    // Get email from URL parameter
    function getEmailFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('email');
    }

    // Format date to German
    function formatDate(dateObj) {
      const date = dateObj instanceof Date ? dateObj : new Date(dateObj);
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear();
      
      const today = new Date();
      const isToday = date.toDateString() === today.toDateString();
      
      return {
        dayFormatted: `${day}.${month}.${year}`,
        isToday: isToday,
        dayName: date.toLocaleDateString('de-DE', { weekday: 'short' })
      };
    }

    // Format month header
    function formatMonth(dateObj) {
      const months = [
        'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
        'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'
      ];
      const month = months[dateObj.getMonth()];
      const year = dateObj.getFullYear();
      
      const today = new Date();
      const isCurrentMonth = dateObj.getMonth() === today.getMonth() && dateObj.getFullYear() === today.getFullYear();
      
      return {
        formatted: `${month} ${year}`,
        isCurrentMonth: isCurrentMonth
      };
    }

    // Format created date
    function formatCreatedDate(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      return date.toLocaleDateString('de-DE', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric'
      });
    }

    // Format time
    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZone: 'Europe/Vienna'
      });
    }

    // Calculate duration in minutes
    function calculateDuration(start, end) {
      const startTime = new Date(start);
      const endTime = new Date(end);
      return Math.round((endTime - startTime) / (1000 * 60));
    }

    // Check if appointment is more than 24 hours away
    function isMoreThan24HoursAway(appointmentTime) {
      const now = new Date();
      const appointment = new Date(appointmentTime);
      const hoursDiff = (appointment - now) / (1000 * 60 * 60);
      return hoursDiff > 24;
    }

    // Generate .ics file content
    function generateICSFile(event) {
      const startDate = new Date(event.start_time);
      const endDate = new Date(event.end_time);
      
      // Format dates for ICS (YYYYMMDDTHHMMSSZ)
      const formatICSDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      const location = event.location?.join_url || event.location?.location || event.location?.type || '';
      const title = event.name || 'Termin';
      const description = `Lerncoaching-Termin mit Anna Braun\\n\\nTeilnehmer: ${event.invitee_name || 'Unbekannt'}`;

      const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Anna Braun Lerncoaching//Terminkalender//DE',
        'BEGIN:VEVENT',
        `UID:${event.id}@einfachlernen.com`,
        `DTSTART:${formatICSDate(startDate)}`,
        `DTEND:${formatICSDate(endDate)}`,
        `SUMMARY:${title}`,
        `DESCRIPTION:${description}`,
        location ? `LOCATION:${location}` : '',
        `DTSTAMP:${formatICSDate(new Date())}`,
        'END:VEVENT',
        'END:VCALENDAR'
      ].filter(line => line).join('\r\n');

      return icsContent;
    }

    // Download .ics file
    function downloadICSFile(event) {
      const icsContent = generateICSFile(event);
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `termin-${event.id}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Generate Google Calendar URL
    function generateGoogleCalendarURL(event) {
      const startDate = new Date(event.start_time);
      const endDate = new Date(event.end_time);
      
      // Format dates for Google Calendar (YYYYMMDDTHHMMSSZ)
      const formatGoogleDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
      };

      const title = encodeURIComponent(event.name || 'Termin');
      const dates = `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`;
      const location = encodeURIComponent(event.location?.join_url || event.location?.location || event.location?.type || '');
      const details = encodeURIComponent(`Lerncoaching-Termin mit Anna Braun\n\nTeilnehmer: ${event.invitee_name || 'Unbekannt'}`);

      const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: title,
        dates: dates,
        details: details,
        location: location,
        trp: false
      });

      return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    // Show detailed error message
    function showError(message, details = null, actions = []) {
      const container = document.getElementById('appointmentsContainer');
      
      let actionsHtml = '';
      if (actions.length > 0) {
        actionsHtml = `
          <div class="error-actions">
            ${actions.map(action => `
              <button class="error-button" onclick="${action.onclick}">
                ${action.icon} ${action.text}
              </button>
            `).join('')}
          </div>
        `;
      }
      
      let detailsHtml = '';
      if (details) {
        detailsHtml = `
          <div class="error-details">
            <strong>Technische Details:</strong><br>
            ${typeof details === 'object' ? JSON.stringify(details, null, 2) : details}
          </div>
        `;
      }
      
      container.innerHTML = `
        <div class="error-message">
          <span class="error-title">Fehler beim Laden der Termine</span>
          ${message}
          ${detailsHtml}
          ${actionsHtml}
        </div>
      `;
    }

    // Render appointments
    function renderAppointments(events) {
      const container = document.getElementById('appointmentsContainer');
      
      if (!events || events.length === 0) {
        container.innerHTML = `
          <div class="no-appointments">
            <div class="no-appointments-icon">📅</div>
            <h2>Keine anstehenden Termine</h2>
            <p>Sie haben derzeit keine gebuchten Termine im gewählten Zeitraum.</p>
          </div>
        `;
        return;
      }

      // Group events by month
      const eventsByMonth = {};
      events.forEach(event => {
        const date = new Date(event.start_time);
        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        if (!eventsByMonth[monthKey]) {
          eventsByMonth[monthKey] = [];
        }
        eventsByMonth[monthKey].push(event);
      });

      let html = '';
      Object.keys(eventsByMonth).sort().forEach(monthKey => {
        const monthEvents = eventsByMonth[monthKey];
        const firstEventDate = new Date(monthEvents[0].start_time);
        const monthInfo = formatMonth(firstEventDate);
        
        html += `
          <div class="calendar-section">
            <div class="date-header">
              📅 ${monthInfo.formatted}
            </div>
        `;

        monthEvents.forEach(event => {
          const startTime = formatTime(event.start_time);
          const endTime = formatTime(event.end_time);
          const duration = calculateDuration(event.start_time, event.end_time);
          const location = event.location?.join_url || event.location?.location || event.location?.type || '–';
          const eventDate = new Date(event.start_time);
          const dateInfo = formatDate(eventDate);
          const createdDate = formatCreatedDate(event.created_at);
          const canReschedule = isMoreThan24HoursAway(event.start_time);
          
          html += `
            <div class="appointment-card">
              <div class="appointment-main">
                <div class="appointment-date-time">
                  <div class="date-info">${dateInfo.dayName} ${dateInfo.dayFormatted}</div>
                  <div class="time-badge">${startTime}–${endTime}</div>
                </div>
                <div class="appointment-title">${event.name || 'Termin'}</div>
                <div class="duration">${duration}m</div>
              </div>

              <div class="appointment-details">
                <div class="detail-item">
                  <div class="detail-icon">🏢</div>
                  <div class="detail-text" title="${location}">${location}</div>
                </div>
                ${event.invitee_name ? `
                <div class="detail-item">
                  <div class="detail-icon">👤</div>
                  <div class="detail-text">${event.invitee_name}</div>
                </div>
                ` : ''}
              </div>

              <div class="status-badges">
                ${event.invitee_status ? `<span class="status-badge status-confirmed">${event.invitee_status}</span>` : ''}
                ${createdDate ? `<span class="status-badge status-created">Gebucht am: ${createdDate}</span>` : ''}
              </div>

              <div class="appointment-actions">
                <button class="action-button btn-calendar" onclick="downloadICSFile(${JSON.stringify(event).replace(/"/g, '&quot;')})">
                  📅 Kalender-Datei
                </button>
                <a class="action-button btn-calendar" href="${generateGoogleCalendarURL(event)}" target="_blank">
                  📅 Google Kalender
                </a>
                ${canReschedule ? 
                  (event.reschedule_url ? 
                    `<a class="action-button btn-reschedule" href="${event.reschedule_url}" target="_blank">✏️ Termin verschieben</a>` :
                    ''
                  ) +
                  (event.cancel_url ? 
                    `<a class="action-button btn-reschedule" href="${event.cancel_url}" target="_blank">❌ Termin stornieren</a>` :
                    ''
                  )
                  : 
                  `<span class="action-button btn-disabled">⏰ Änderungen nicht möglich</span>`
                }
              </div>
              ${!canReschedule ? '<div class="reschedule-notice">Umbuchungen nur bis 24 Stunden vor dem Termin möglich</div>' : ''}
            </div>
          `;
        });

        html += '</div>';
      });

      container.innerHTML = html;
    }

    // Load appointments with enhanced error handling
    async function loadAppointments(email) {
      try {
        console.log('Loading appointments for:', email);
        
        const response = await fetch(`calendly_api.php?email=${encodeURIComponent(email)}`);
        console.log('API Response status:', response.status);
        console.log('API Response headers:', Object.fromEntries(response.headers.entries()));
        
        const responseText = await response.text();
        console.log('API Response (raw):', responseText.substring(0, 500));
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          throw new Error(`Server antwortete mit ungültigem JSON. Response: ${responseText.substring(0, 200)}`);
        }
        
        console.log('API Response (parsed):', data);
        
        if (data.error) {
          throw new Error(data.error + (data.debug ? `\n\nDebug: ${JSON.stringify(data.debug)}` : ''));
        }
        
        console.log(`Found ${data.events?.length || 0} appointments`);
        renderAppointments(data.events || []);
        
      } catch (error) {
        console.error('Error loading appointments:', error);
        
        const actions = [
          {
            text: 'Erneut versuchen',
            icon: '🔄',
            onclick: `loadAppointments('${email}')`
          },
          {
            text: 'Konfiguration prüfen',
            icon: '🔧',
            onclick: `window.open('calendly_api.php?debug=1', '_blank')`
          },
          {
            text: 'Support kontaktieren',
            icon: '📧',
            onclick: `window.open('mailto:info@einfachlernen.com?subject=Termine laden fehlgeschlagen&body=Fehler: ${encodeURIComponent(error.message)}', '_blank')`
          }
        ];
        
        showError(error.message || 'Unbekannter Fehler beim Laden der Termine.', null, actions);
      }
    }

    // Initialize page
    function init() {
      const email = getEmailFromURL();
      
      if (!email) {
        showError('Fehlender Parameter: ?email=adresse@example.com', 'URL-Parameter fehlt', [
          {
            text: 'Zur Startseite',
            icon: '🏠',
            onclick: `window.location.href = 'index.html'`
          }
        ]);
        hideLoading();
        return;
      }
      
      if (!/\S+@\S+\.\S+/.test(email)) {
        showError('Ungültige E-Mail-Adresse.', `E-Mail: ${email}`, [
          {
            text: 'Zur Startseite',
            icon: '🏠', 
            onclick: `window.location.href = 'index.html'`
          }
        ]);
        hideLoading();
        return;
      }
      
      // Set email in UI
      document.getElementById('userEmail').textContent = email;
      
      // Load appointments
      loadAppointments(email).finally(() => {
        hideLoading();
      });
    }

    // Hide loading animation
    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      const mainContent = document.getElementById('mainContent');
      
      if (loadingOverlay) {
        loadingOverlay.classList.add('fade-out');
        setTimeout(() => loadingOverlay.remove(), 500);
      }
      
      if (mainContent) {
        mainContent.classList.add('show');
      }
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // Rotate loading emojis
    function startLoadingEmojiRotation() {
      const emojis = ['🧠', '🗓️', '🦦', '⏰'];
      let currentIndex = 0;
      const loadingLogo = document.getElementById('loadingLogo');
      
      if (!loadingLogo) return;
      
      const rotateEmoji = () => {
        if (!document.getElementById('loadingLogo')) return;
        currentIndex = (currentIndex + 1) % emojis.length;
        loadingLogo.textContent = emojis[currentIndex];
      };
      
      return setInterval(rotateEmoji, 1600);
    }

    // Start emoji rotation
    const emojiInterval = startLoadingEmojiRotation();

    // Clean up interval when loading is done
    const originalHideLoading = hideLoading;
    hideLoading = function() {
      clearInterval(emojiInterval);
      originalHideLoading();
    };

    // Fallback: Hide loading after 30 seconds maximum
    setTimeout(() => {
      if (document.getElementById('loadingOverlay')) {
        clearInterval(emojiInterval);
        hideLoading();
      }
    }, 30000);
  </script>
</body>
</html>